# Network Node (Django + DRF)

Небольшой Django-проект (онлайн‑сеть по продаже электроники), предоставляющий REST API для управления иерархией узлов сети (завод → розница → ИП) и продуктами. Доступ к API выдаётся только аутентифицированным и активным пользователям.

Этот файл описывает стек, переменные окружения, настройку и запуск, скрипты, тесты, структуру проекта и лицензионные примечания.

## Обзор
- Домен: узлы торговой сети электроники и продукты.
- Ключевые возможности:
  - CRUD для моделей NetworkNode и Product.
  - Вычисляемый иерархический уровень для каждого узла.
  - Фильтрация по стране и поиск по имени/городу.
  - Разрешения: доступ только аутентифицированным активным пользователям.
- Базовый путь API: `/api/`.

## Технологический стек (обнаружено)
- Язык: Python 3.11
- Фреймворки/библиотеки:
  - Django (в pyproject: ^4.2)
  - Django REST Framework (DRF) (^3.14)
  - django-filter (^23.3)
- База данных: PostgreSQL (psycopg2-binary)
- Инструменты:
  - Poetry (менеджер пакетов/виртуальной среды)
  - pytest, pytest-django, pytest-cov (тестирование)
  - flake8, black, isort (линтинг/форматирование)
  - Docker + Docker Compose (локальная разработка)
  - GitHub Actions (CI) — файл `.github/workflows/django-ci.yml`

Примечания:
- В заголовке settings.py написано «Generated by Django 5.2.7», тогда как в pyproject указан Django ^4.2. Фактическая версия контролируется Poetry. TODO: согласовать/убрать этот сгенерированный заголовок или повысить зависимость до фактически используемой версии.

## Требования
- Python 3.11+
- Poetry 1.8.x
- PostgreSQL 15+ (для локального запуска без Docker)
- Необязательно для контейнерного сценария:
  - Docker (рекомендуется Engine 24+)
  - Docker Compose v2

## Структура проекта
- `config/` — Django‑проект:
  - `settings.py` — настройки на основе переменных окружения (Postgres, REST framework и т. п.).
  - `urls.py` — подключает админку по `/admin/` и API приложения по `/api/`.
  - `wsgi.py`, `asgi.py` — точки входа WSGI/ASGI.
- `network_node/` — основное приложение:
  - `models.py` — модели Product и NetworkNode со свойством hierarchy_level.
  - `serializers.py` — DRF‑сериализаторы; поле задолженности (debt) доступно только для чтения через API.
  - `views.py` — viewset’ы DRF с фильтрацией и поиском.
  - `permissions.py` — разрешение `IsActiveEmployee` (доступ только аутентифицированным активным пользователям).
  - `urls.py` — регистрирует роутеры для узлов и продуктов.
  - `management/commands/wait_for_db.py` — утилита для ожидания БД при старте в Docker.
  - `tests/` — набор тестов pytest (API, админка, модели) с фикстурами.
- `manage.py` — точка входа для команд Django.
- `Dockerfile`, `docker-compose.yml` — контейнеризация для dev/prod.
- `Makefile` — частые команды (Poetry, Docker, тесты, линтинг, runserver и т. п.).
- `pyproject.toml`, `poetry.lock` — зависимости и конфигурация инструментов.
- `.github/workflows/django-ci.yml` — конвейер CI (линт, проверка форматирования, тесты).

## Переменные окружения
Приложение читает конфигурацию из переменных окружения. Типичные переменные, используемые в настройках, Docker и CI:
- `SECRET_KEY` — секретный ключ Django. Обязателен.
- `POSTGRES_DB` — имя базы данных. Обязательно.
- `POSTGRES_USER` — пользователь БД. Обязательно.
- `POSTGRES_PASSWORD` — пароль БД. Обязательно.
- `POSTGRES_HOST` — хост БД. По умолчанию `db` в Docker (`config("POSTGRES_HOST", default="db")`), и `localhost` в CI через флаг `is_ci`. Укажите свой хост при локальном запуске без Docker.
- `POSTGRES_PORT` — порт БД (например, 5432).
- `CI` — если установлено в "true" в CI, настройки используют `localhost` как хост БД для тестов.

Необязательно/заметки:
- `DEBUG` сейчас жёстко задан как `True` в settings.py. TODO: сделать его управляемым через окружение.
- `ALLOWED_HOSTS` по умолчанию пуст. TODO: настроить для продакшена.

Пример `.env` для Docker Compose (не коммитьте секреты):
```
SECRET_KEY=dev-secret-key
POSTGRES_DB=app_db
POSTGRES_USER=app_user
POSTGRES_PASSWORD=app_password
POSTGRES_HOST=db
POSTGRES_PORT=5432
```

## Быстрый старт (локально без Docker)
1) Установите Poetry и зависимости:
- Установка Poetry: https://python-poetry.org/docs/
- В корне репозитория:
  - `poetry install`

2) Убедитесь, что PostgreSQL запущен, и создайте БД/пользователя согласно вашим переменным окружения.
- Задайте переменные окружения (или создайте локальный `.env` и загрузите его в оболочке), затем выполняйте стандартные команды Django через Poetry.

3) Примените миграции и создайте суперпользователя:
- `poetry run python manage.py migrate`
- `poetry run python manage.py createsuperuser`

4) Запустите dev‑сервер:
- `poetry run python manage.py runserver`
- Приложение будет доступно по адресу http://127.0.0.1:8000/

## Быстрый старт (с Docker Compose)
1) Создайте файл `.env` в корне проекта (см. пример выше).
2) Соберите и запустите сервисы:
- `make build`
- `make up`
- Логи (опционально): `make logs`

Сервис `web` стартует так: wait_for_db → migrate → runserver на `0.0.0.0:8000`.

3) Создайте суперпользователя в работающем контейнере:
- `make createsuperuser`

4) Остановите сервисы:
- `make down`

## Цели Makefile (скрипты)
- install: `poetry install`
- build/up/down/logs: жизненный цикл Docker Compose
- shell: открыть Django shell в контейнере `web`
- migrate/makemigrations/createsuperuser/check: типовые команды Django (в контейнере)
- runserver: запуск dev‑сервера локально (без Docker)
- test: запуск тестов в Docker (`pytest -vv`)
- test-cov: покрытие в Docker
- test-local: запуск тестов локально через Poetry
- format: `black` + `isort`
- lint: `flake8`
- clean: удаление кэшей и артефактов покрытия
- all: удобная цель первого запуска (`clean install build up migrate`)

## Краткая справка по API
База: `http://localhost:8000/api/`

- Узлы сети: `GET/POST /api/nodes/`, `GET/PUT/PATCH/DELETE /api/nodes/{id}/`
  - Фильтры: `?country=Россия`
  - Поиск: `?search=Москва` (по имени, городу)
- Продукты: `GET/POST /api/products/`, `GET/PUT/PATCH/DELETE /api/products/{id}/`

Разрешения:
- Кастомное разрешение `IsActiveEmployee`: пользователь должен быть аутентифицирован и иметь `is_active=True`.
- TODO: документировать точные методы аутентификации (Session, Basic, Token и т. п.). По умолчанию явно не настроены.

Админка:
- Django Admin доступна по `/admin/`.

## Запуск тестов
- Локально (Poetry): `poetry run pytest -v`
- В Docker: `make test`
- С покрытием: `poetry run pytest --cov=network_node --cov-report=term-missing` или `make test-cov`

pytest настроен в `pytest.ini` на повторное использование БД и сбор покрытия для пакета `network_node`.

## CI/CD
- GitHub Actions workflow: `.github/workflows/django-ci.yml`
  - Матрица Python 3.11 и 3.12
  - Поднимает сервис Postgres
  - Устанавливает зависимости через Poetry
  - Запускает flake8, black --check, isort --check-only
  - Выполняет `manage.py check`, применяет миграции, запускает тесты pytest и выгружает покрытие в Codecov (если настроен токен)

## Docker‑образы
- Многостадийный Dockerfile:
  - стадия `development`: установка dev‑зависимостей.
  - стадия `production`: выполняет миграции и стартует Django через `runserver`.
- TODO: для настоящего продакшена перейти на WSGI/ASGI‑сервер (gunicorn/uvicorn) и настроить раздачу статики/медиа.

## Лицензия
- TODO: добавить файл LICENSE (например, MIT) и обновить этот раздел.

## Известные TODO / Открытые вопросы
- Согласовать текст версии Django в settings с зависимостью в pyproject.
- Сделать `DEBUG` и `ALLOWED_HOSTS` управляемыми окружением для деплоя.
- Проверить/обеспечить наличие `rest_framework` и `django_filters` в `INSTALLED_APPS` (как рекомендуют доки DRF).
- Документировать выбранные методы аутентификации для API (Session, Basic, Token и т. п.).
